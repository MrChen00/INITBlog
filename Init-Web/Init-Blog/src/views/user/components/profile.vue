<template>
<div class="profile-container" style="padding: 6px; ">
    <el-row :gutter="10">
        <el-col  :xs="0" :sm="4" :md="4" :offset="3">
            <type></type>
        </el-col>
         <el-col :xs="24" :sm="0" :md="0" :offset="1">
                <el-tag><router-link to="/user/profile" tag="span">Âü∫Êú¨‰ø°ÊÅØ</router-link></el-tag>
                <el-tag><router-link to="/user/article" tag="span">ÊñáÁ´†ÁÆ°ÁêÜ</router-link></el-tag>
                <el-tag><router-link to="/user/collect" tag="span">ÊàëÁöÑÊî∂Ëóè</router-link></el-tag>
                <el-tag><router-link to="/user/message" tag="span">Ê∂àÊÅØÂíåÁïôË®Ä</router-link></el-tag>
        </el-col>
        <el-col :xs="24" :sm="18" :md="14">
        <div class="profile">
            <el-card shadow="always" class="profile-one" >
                    <div style="text-align: center">
                        <!-- Â§¥ÂÉè‰ø°ÊÅØ/‰∏ä‰º† -->
                         <!-- action="http://39.107.82.119:8018/initblog/user/uploadHportrait"
                             action="http://127.0.0.1:8018/initblog/user/uploadHportrait" -->
                        <el-upload
                            class="avatar-uploader"
                            action="http://39.107.82.119:8018/initblog/user/uploadHportrait"
                            :show-file-list="false"
                            :data="uploadData"
                            :on-success="uploadSuccess"
                            :before-upload="beforeUpload">
                            <img  :src="users.hportrait" class="avatar">
                        </el-upload>
                        <!-- <img :src="users.hportrait"/> -->
                        <br/>
                            <div v-if="updateNickName != ''" >
                                <i class="el-icon-circle-close-outline" @click="hanlderName(false)"/>
                                <el-input 
                                style="width: 100px; margin-top: 11.5px" 
                                placeholder="‰øÆÊîπÊòµÁß∞" 
                                v-model="updateNickName" />
                                <i @click="hanlderName(true)" 
                                    class="el-icon-circle-check-outline"></i> 
                            </div>
                            <el-tooltip class="item" effect="dark" content="ÁÇπÂáª‰øÆÊîπÊòµÁß∞" placement="bottom">
                                <h2 @click="updateName" v-if="updateNickName == ''"  >{{ users.nickname }}</h2>
                            </el-tooltip>
                    </div>
                    <div class="profile-bottom">
                        <p>
                            <span @click="getFollows">üíó ÂÖ≥Ê≥®</span>&nbsp;{{ follow.follow }}  
                            <span @click="getLikes">üòÄ Á≤â‰∏ù</span>&nbsp;{{ follow.like }}  
                            <span>üòÜ ÊµèËßàÈáè</span>&nbsp;{{ proFileForm.upageView }}
                        </p>
                    </div>
            </el-card>
             <transition name="el-zoom-in-top">
                <div class="follow" v-show="!show2">
                    <el-card shadow="always" style="border-radius: 20px">
                            <h4>ÊàëÁöÑÂÖ≥Ê≥®</h4>
                            <h4 v-if="follows == ''" style="text-align: center">‰Ω†ÂΩìÂâçÊ≤°Êúâ‰ªª‰ΩïÂÖ≥Ê≥®</h4>
                            <div v-for="item in follows" 
                                    class="borderBottom"
                                    :key="item.id">
                                    <img :src="item.hportrait"  />
                                    <router-link :to="'/' + item.id" tag="span">
                                        {{ item.nickname }}
                                    </router-link>
                                    <el-button size="small" style="float:right"
                                        @click="cancelFollow(item.id)">
                                        ÂèñÊ∂àÂÖ≥Ê≥®
                                    </el-button>
                            </div>
                    </el-card>
                </div>
             </transition>
                <transition name="el-zoom-in-top">
                    <div class="follow" v-show="show2" >
                        <el-card shadow="always" style="border-radius: 20px">
                                <h4>ÊàëÁöÑÁ≤â‰∏ù</h4>
                                <h4 v-if="likes == ''" style="text-align: center">‰Ω†ÂΩìÂâçÊ≤°Êúâ‰ªª‰ΩïÁ≤â‰∏ù</h4>
                                <div v-for="item in likes" 
                                        class="borderBottom"
                                        style="border-bottom: 1px solid rgba(0,0,0,0.1);"
                                        :key="item.id">
                                        <img :src="item.hportrait"  />
                                        <router-link :to="'/' + item.id" tag="span">
                                            {{ item.nickname }}
                                        </router-link>
                                </div>
                        </el-card>
                    </div>
                </transition>
                <div class="profile-basic">
                    <div >
                        <ul >
                            <li><span>ÂßìÂêç:</span> {{ proFileForm.realName }}</li>
                            <li><span>ÊÄßÂà´:</span> {{ proFileForm.sex }}</li>
                            <li><span>ÁîüÊó•:</span> {{ proFileForm.birthday }}</li>
                            <!-- <li><span>Âú∞Âå∫:</span> {{ proFileForm.region }}</li> -->
                            <li><span>ËÅå‰Ωç:</span> {{ proFileForm.post }}</li>
                            <li><span>‰∏™‰∫∫ÁÆÄ‰ªã:</span> {{ proFileForm.intro }}</li>
                            <li><el-button @click="proFileFormVisible=true" >‰øÆÊîπ</el-button></li>
                        </ul>  
                    </div>
                </div>
                    <el-dialog :visible.sync="proFileFormVisible" >
                        <el-form :model="proFileForm" :rules="proFileRules" ref="proFileRef" >
                            <el-form-item label="ÂßìÂêç" prop="realName">
                                <el-input v-model="proFileForm.realName"></el-input>
                            </el-form-item>
                            <el-form-item label="ÊÄßÂà´" prop="sex">
                                <el-radio-group v-model="proFileForm.sex">
                                    <el-radio label="Áî∑"></el-radio>
                                    <el-radio label="Â•≥"></el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <el-form-item label="ÁîüÊó•" prop="birthday">
                                <el-date-picker
                                    v-model="proFileForm.birthday"
                                    type="date"
                                    format="yyyy Âπ¥ MM Êúà dd Êó•">
                                </el-date-picker>   
                            </el-form-item>
                            <!-- <el-form-item label="Âú∞Âå∫" prop="region">
                                <el-input placeholder="ËøôÈáåÊú¨Êù•ÊòØ‰∏âÁ∫ßËÅîÂä®ÁöÑ, Âõ†‰∏∫Áé∞Âú®Ê≤°ÊúâÊâÄ‰ª•‰ΩøÁî®id" v-model="proFileForm.region" />
                            </el-form-item> -->
                            <el-form-item label="ËÅå‰Ωç" prop="post">
                                <el-input v-model="proFileForm.post" />
                            </el-form-item>
                            <el-form-item label="‰∏™‰∫∫ÁÆÄ‰ªã" prop="intro">
                                <el-input v-model="proFileForm.intro" />
                            </el-form-item>
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="saveProfile" type="primary" >Á°ÆÂÆö</el-button>
                            <el-button @click="cancelProfile">ÂèñÊ∂à</el-button>
                        </div>
                    </el-dialog>
                </div>
        </el-col>
    </el-row>
</div>
</template>

<script>
import type from './type'
import { getProfile, updateProfile, updateBasic } from '@/api/user'
import { getToken, setToken, removeToken } from '@/utils/cookie'
import { getUser } from '@/api/home'

import { countFollow, countLike, listLike, listFollow, deleteFollow } from '@/api/follow'


export default {
    name: "profile",
    data() {
        return {
            // Âü∫Êú¨‰ø°ÊÅØË°®Âçï
            proFileFormVisible: false,
            // Ë°®ÂçïÊï∞ÊçÆ
            proFileForm: { 
                uid: '',
                realName: '',
                sex: '',
                birthday: '',
                region: '',
                post: '',
                intro: '',
                upageView: ''
            },
            // È™åËØÅ ‰πãÂêéÊúâË¶ÅÊ±ÇÂÜçÂÜô
            proFileRules: {},
            user: this.$store.getters.user,
            // Áî®Êà∑‰ø°ÊÅØ
            users: {},
            // ÂÖ≥Ê≥®‰ø°ÊÅØ
            follow: {
                follow: '',
                like: ''
            },
            // ÊâÄÊúâÂÖ≥Ê≥®‰ø°ÊÅØ
            follows: [],
            // ÊâÄÊúâÁ≤â‰∏ù‰ø°ÊÅØ
            likes: [],
            show2: false,
            // ‰øÆÊîπÊòµÁß∞ÂèÇÊï∞
            updateNickName: '',
            uploadData:{
                id: this.$store.getters.user
            }
        }
    },
    methods: {
        // Ëé∑ÂèñÂü∫Êú¨‰ø°ÊÅØ
        setProfile(){
            getProfile(this.user).then(response => {
                this.proFileForm = response.data.data
            })
        },
        // ÂÖ≥Ê≥®/Á≤â‰∏ù
        setFollow(){
            countFollow(this.user).then(resp => {
                this.follow.follow = resp.data.data
            })
            countLike(this.user).then(resp => {
                this.follow.like = resp.data.data
            })
            listFollow(this.user).then(resp => {
                this.follows = resp.data.data
            })
        },
        // ‰øÆÊîπÂü∫Êú¨‰ø°ÊÅØ
        saveProfile(){
            this.proFileForm.uid = this.user
            updateProfile(this.proFileForm).then(response => {
                if(response.data.code == 20000){
                    this.proFileFormVisible = false      
                    this.$notify({
                        title: 'ÊàêÂäü',
                        message: '‰øÆÊîπÊàêÂäü',
                        type: 'success'
                    });
                }else{
                    this.$notify({
                        title: 'Â§±Ë¥•',
                        message: '‰øÆÊîπÂ§±Ë¥•',
                        type: 'error'
                    });
                }
            })
        },
        // ÂèñÊ∂à‰øÆÊîπ
        cancelProfile(){
            // Áî±‰∫éÊï∞ÊçÆÊòØÂèåÂêëÁªëÂÆöÁöÑ, ÂèñÊ∂àÊó∂‰ºöÂ∞Ü‰ø°ÊÅØÂÆûÊó∂Êõ¥Êñ∞ÊâÄ‰ª•Âà∑Êñ∞
            this.setProfile()
            this.proFileFormVisible = false  
        },
        // ÂèñÊ∂àÂÖ≥Ê≥®
        cancelFollow(id){
            deleteFollow(this.user, id).then(resp => {
                this.$notify({
                    title: 'ÊàêÂäü',
                    message: 'ÂèñÊ∂àÂÖ≥Ê≥®ÊàêÂäü',
                    type: 'success'
                });
                this.setFollow()
            })
        },
        // ÊâÄÊúâÁ≤â‰∏ù‰ø°ÊÅØ
        getLikes(){
            this.show2 = true
            listLike(this.user).then(resp => {
                this.likes = resp.data.data
            })
        },
        // ÊâÄÊúâÂÖ≥Ê≥®‰ø°ÊÅØ
        getFollows(){
            this.show2 = false
            listFollow(this.user).then(resp => {
                this.follows = resp.data.data
            })
        },
        // ‰øÆÊîπÊòµÁß∞
        updateName(){
           this.updateNickName = this.users.nickname
        },
        // ÊòØÂê¶‰øÆÊîπÊòµÁß∞
        hanlderName(bear){
            if(bear){
                const user = {
                    id: this.user,
                    nickName: this.updateNickName
                }
                updateBasic(user).then(resp =>{
                    if(resp.data.code != 20000){
                        this.$notify.error({
                            title: '‰øÆÊîπÂ§±Ë¥•',
                            message: 'ËØ∑Á®çÂêéÈáçËØï!'
                        });
                    }else{
                         this.users.nickname = this.updateNickName
                         this.$notify({
                            title: 'ÊàêÂäü',
                            message: '‰øÆÊîπÊàêÂäü!',
                            type: 'success'
                        });
                    }
                    this.updateNickName = ''
                })
            }else{
                this.updateNickName = ''
            }
        },
        // ‰∏ä‰º†ÊàêÂäü
        uploadSuccess(res, file){
            this.users.hportrait = res.data
        },
        // ‰∏ä‰º†‰πãÂâç
        beforeUpload(file){
            const isJPG = file.type === "image/jpeg" || file.type === 'image/png'
            const isLt2M = file.size / 1024 / 1024 < 6
            if (!isJPG) {
                this.$message.error('‰∏ä‰º†Â§¥ÂÉèÂõæÁâáÂè™ËÉΩÊòØ JPG/PNG Ê†ºÂºè!')
            }
            if (!isLt2M) {
                this.$message.error('‰∏ä‰º†Â§¥ÂÉèÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 6MB!')
            }
            return isJPG && isLt2M;
        }
    },
    components: {
        type
    },
    mounted() {
        this.setProfile()
        // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
        getUser(this.user).then(resp => {
            this.users = resp.data.data
            
        })
        this.setFollow()
    },
    created(){
        // Âà§Êñ≠Áî®Êà∑ÊòØÂê¶ÁôªÂΩï
        if(!getToken("token")){
            this.$message({
                showClose: true,
                message: "ÊÇ®ÂΩìÂâçÊú™ÁôªÂΩï!",
                type: 'error'
            })
            
            this.$router.push("/")
        }
    }
}
</script>


<style rel="stylesheet/scss" lang="scss" scoped>
    @import "~@/styles/userProfile.scss";
</style>
